{% load i18n wagtailadmin_tags wagtailiconchooser_tags monitoring_tags %}


<style>
    .station-activity-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .station-activity-panel {
        padding: 32px;
        min-height: 420px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
    }

    .station-activity-panel .t-header {
        display: flex;
        flex-direction: column;
        font-size: 18px;
        gap: 8px;
        padding: 16px 0;
    }

    .station-activity-panel .t-header-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        padding-bottom: 16px;
        border-bottom: 1px solid #e2e8f0
    }

    .station-activity-panel .t-header .t-icon-large svg {
        height: 20px;
        width: 20px;
    }

    .station-activity-panel .t-header .network-name {
        color: #111827; /* Dark gray */
        font-size: 20px;
    }

    .t-icon-large {
        display: flex;
        align-items: center;
    }

    .t-panel-icon-large svg {
        height: 30px;
        width: 30px;
    }

    .t-panel-icon-small {
        display: flex;
        align-items: center;
    }

    .t-panel-icon-small svg {
        height: 16px;
        width: 16px;
    }

    .t-panel-meta {
        padding: 10px 0;
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
        background: #f7f8fa;
    }

    .t-panel-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 0 8px;
    }

    .meta-parts {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .meta-part {
        margin-right: 4px;
    }


    /* Chip bar */
    .t-filter-chips {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 8px 0;
    }

    .t-filter-chips .chip {
        appearance: none;
        border: 1px solid #e5e7eb;
        background: #fff;
        color: #111827;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 13px;
        line-height: 18px;
        cursor: pointer;
        transition: background .15s ease, border-color .15s ease, color .15s ease;
    }

    .t-filter-chips .chip:hover {
        border-color: #cbd5e1;
        background: #f8fafc;
    }

    .t-filter-chips .chip.active {
        background: #111827;
        color: #fff;
        border-color: #111827;
    }

    .t-wrapper {
        position: relative;
        min-height: 200px;
    }


    .timeline-loader-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999999;
        font-size: 14px;
        color: #111827;
        font-weight: 500;

        /* Start hidden */
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease-in-out;
    }

    .timeline-loader-overlay.visible {
        opacity: 1;
        pointer-events: auto;
    }

    .timeline-loader-spinner {
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-top: 3px solid #111827;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }


    /* Vis Timeline */
    .vis-item .vis-item-content {
        color: #fff;
        font-weight: 600;
    }

    /* Success with data vs without */
    .vis-item.success-with-records {
        background: #16a34a;
        border-color: #15803d;
    }

    .vis-item.success-no-records {
        background: #000;
        border-color: #111827;
    }

    /* Errors */
    .vis-item.error-with-message {
        background: #dc2626;
        border-color: #b91c1c;
    }

    .vis-item.error-no-message {
        background: #ef4444;
        border-color: #dc2626;
    }

    /* Improve focus ring for a11y */
    .vis-item.vis-selected {
        box-shadow: 0 0 0 2px #111827 inset;
    }

    .vis-label.station-group .vis-inner {
        font-weight: bold;
        font-size: 14px;
    }

    .station-push-panel {
        margin-top: 20px;
    }

    .station-push-panel .w-tabs__list, .station-push-panel .w-tabs .tab-content {
        padding-inline-end: 0;
        padding-inline-start: 0;
    }

    .channels-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        padding: 16px 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .channels-title .t-icon-large svg {
        height: 20px;
        width: 20px;
    }

    .t-controls {
        display: flex;
        justify-content: flex-end;
        padding: 8px 0;
    }

    .t-refresh-now {
    }

    .t-refresh-now:hover {
        opacity: .9;
    }

    .t-wrapper.just-refreshed {
        outline: 2px solid var(--w-color-surface-button-default);
        outline-offset: 2px;
        transition: outline .2s ease;
    }


</style>

<div class="station-activity-container">
    {% for network_connection in network_connections %}
        <div class="station-activity-panel">
            <div class="t-header">
                <div class="t-header-title">
                    <div class="t-icon-large">
                        {% icon name="plug" classname="..." title="..." %}
                    </div>
                    <div class="network-name">{{ network_connection.name }}</div>
                </div>
                <div class="t-panel-meta">
                    {% if network_connection.plugin_processing_enabled %}
                        <div class="t-panel-meta-item">
                            <div class="t-panel-icon-small" style="color: var(--w-color-positive-100)">
                                {% icon name="circle-check" %}
                            </div>
                            <div>{% translate "Enabled" %}</div>
                        </div>
                    {% else %}
                        <div class="t-panel-meta-item">
                            <div class="t-panel-icon-small" style="color: var(--w-color-critical-200)">
                                {% icon name="error" %}
                            </div>
                            <div>{% translate "Disabled" %}</div>
                        </div>
                    {% endif %}
                    <div class="t-panel-meta-item">
                        <div class="t-panel-icon-small">{% icon name="time" %}</div>
                        <div class="meta-parts">
                            <span class="meta-part">{% translate "Processing interval: " %}</span>
                            <span class="meta-part">{{ network_connection.plugin_processing_interval }}</span>
                            <span class="meta-part">{% translate "minutes" %}</span>
                        </div>
                    </div>
                    <div class="t-panel-meta-item">
                        <div class="t-panel-icon-small">{% icon name="map-pin" %}</div>
                        <div class="meta-parts">
                            <span class="meta-part">{% translate "Linked Stations: " %}</span>
                            <span class="meta-part">{{ network_connection.station_links.count }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="t-wrapper">
                <div id="t-controls-{{ network_connection.id }}"></div>
                <div id="t-timeline-{{ network_connection.id }}"></div>
            </div>
            <script>
                new StationsActivityTimeline({
                    connectionId: "{{ network_connection.id }}",
                    timelineElId: "t-timeline-{{ network_connection.id }}",
                    apiBaseUrl: "{{ data_api_base_url }}",
                    defaultDirection: "pull",
                    controlsElId: "t-controls-{{ network_connection.id }}",
                });
            </script>
            {% if network_connection.dispatch_channels.all %}
                <div class="station-push-panel">
                    <div class="channels-title">
                        <div class="t-icon-large">
                            {% icon name="resubmit" classname="..." title="..." %}
                        </div>
                        Dispatch Channels
                    </div>
                    <div class="w-tabs" data-tabs>
                        <div class="w-tabs__wrapper">
                            <div role="tablist" class="w-tabs__list">
                                {% for channel in network_connection.dispatch_channels.all %}
                                    <a id="tab-label-{{ channel.id }}" href="#tab-channel-{{ channel.id }}"
                                       class="w-tabs__tab "
                                       role="tab"
                                       aria-selected="false"
                                       aria-controls="tab-channel-{{ channel.id }}">
                                        {{ channel.name }}
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="tab-content">
                            {% for channel in network_connection.dispatch_channels.all %}
                                <section id="tab-channel-{{ channel.id }}"
                                         class="w-tabs__panel"
                                         role="tabpanel"
                                         aria-labelledby="tab-label-{{ channel.id }}"
                                         hidden
                                >
                                    <div class="channel-activity-panel">
                                        <div class="t-panel-meta" style="margin-bottom: 20px;background: none">
                                            {% if channel.enabled %}
                                                <div class="t-panel-meta-item">
                                                    <div class="t-panel-icon-small"
                                                         style="color: var(--w-color-positive-100)">
                                                        {% icon name="circle-check" %}
                                                    </div>
                                                    <div>{% translate "Enabled" %}</div>
                                                </div>
                                            {% else %}
                                                <div class="t-panel-meta-item">
                                                    <div class="t-panel-icon-small"
                                                         style="color: var(--w-color-critical-200)">
                                                        {% icon name="error" %}
                                                    </div>
                                                    <div>{% translate "Disabled" %}</div>
                                                </div>
                                            {% endif %}
                                            <div class="t-panel-meta-item">
                                                <div class="t-panel-icon-small">{% icon name="time" %}</div>
                                                <div class="meta-parts">
                                                    <span class="meta-part">{% translate "Data Check interval: " %}</span>
                                                    <span class="meta-part">{{ channel.data_check_interval }}</span>
                                                    <span class="meta-part">{% translate "minutes" %}</span>
                                                </div>
                                            </div>
                                            {% if channel.public_url %}
                                                <div class="t-panel-meta-item">
                                                    <div class="t-panel-icon-small">{% icon name="link-external" %}</div>
                                                    <div class="meta-parts">
                                                        <span class="meta-part">{% translate "Public Url: " %}</span>
                                                        <a href="{{ channel.public_url }}" target="_blank">
                                                            <span class="meta-part">{{ channel.public_url }}</span>
                                                        </a>

                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="t-wrapper">
                                            <div id="p-controls-{{ channel.id }}"></div>
                                            <div id="p-channel-timeline-{{ channel.id }}"></div>
                                        </div>
                                        <script>
                                            new StationsActivityTimeline({
                                                connectionId: "{{ network_connection.id }}",
                                                timelineElId: "p-channel-timeline-{{ channel.id }}",
                                                apiBaseUrl: "{{ data_api_base_url }}",
                                                defaultDirection: "push",
                                                channelId: "{{ channel.id }}",
                                                controlsElId: "p-controls-{{ channel.id }}",
                                            });
                                        </script>
                                    </div>
                                </section>
                            {% endfor %}
                        </div>
                    </div>

                </div>
            {% endif %}
        </div>
    {% endfor %}
</div>



